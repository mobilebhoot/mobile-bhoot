/**
 * Comprehensive Vulnerability Detection Service
 * Detects system-level vulnerabilities, misconfigurations, and security issues
 * This is different from appSecurityService which focuses on individual apps
 */

import * as Device from 'expo-device';
import * as Application from 'expo-application';
import { Platform } from 'react-native';
import AsyncStorage from '@react-native-async-storage/async-storage';

class VulnerabilityDetectionService {
  constructor() {
    this.vulnerabilities = [];
    this.lastScanTime = null;
    this.knownCVEs = this.initializeKnownCVEs();
  }

  // Initialize known CVE database for mobile platforms
  initializeKnownCVEs() {
    return {
      android: {
        // Critical Android vulnerabilities by version
        '10': [
          {
            cve: 'CVE-2023-21036',
            severity: 'critical',
            title: 'Android Framework Privilege Escalation',
            description: 'Critical vulnerability in Android Framework allowing privilege escalation',
            cvss: 9.8
          },
          {
            cve: 'CVE-2023-21035',
            severity: 'high',
            title: 'Media Framework Remote Code Execution',
            description: 'High severity RCE vulnerability in Android Media Framework',
            cvss: 8.8
          }
        ],
        '11': [
          {
            cve: 'CVE-2023-21034',
            severity: 'high',
            title: 'System UI Information Disclosure',
            description: 'Information disclosure vulnerability in Android System UI',
            cvss: 7.5
          }
        ],
        '12': [
          {
            cve: 'CVE-2023-21033',
            severity: 'medium',
            title: 'Bluetooth Stack Memory Corruption',
            description: 'Memory corruption in Bluetooth stack',
            cvss: 6.5
          }
        ]
      }
    };
  }

  // Main vulnerability scanning function
  async performVulnerabilityScan() {
    console.log('üîç Starting comprehensive vulnerability scan...');
    this.vulnerabilities = [];
    this.lastScanTime = new Date();

    try {
      // 1. System-level vulnerabilities
      await this.scanSystemVulnerabilities();
      
      // 2. Configuration vulnerabilities
      await this.scanConfigurationIssues();
      
      // 3. Network security vulnerabilities
      await this.scanNetworkVulnerabilities();
      
      // 4. Permission-based vulnerabilities
      await this.scanPermissionVulnerabilities();
      
      // 5. Device security posture
      await this.scanDeviceSecurityPosture();
      
      // 6. Known CVE matching
      await this.scanKnownCVEs();

      // Cache results
      await this.cacheResults();
      
      console.log(`‚úÖ Vulnerability scan completed: ${this.vulnerabilities.length} issues found`);
      return this.vulnerabilities;
      
    } catch (error) {
      console.error('‚ùå Vulnerability scan failed:', error);
      return [];
    }
  }

  // Scan for system-level vulnerabilities
  async scanSystemVulnerabilities() {
    const deviceInfo = await this.getDeviceInfo();
    
    // Android version vulnerabilities
    if (Platform.OS === 'android') {
      const androidVersion = parseInt(deviceInfo.osVersion);
      
      if (androidVersion < 12) {
        this.addVulnerability({
          id: `sys-android-${androidVersion}`,
          title: 'Outdated Android Version',
          description: `Android ${androidVersion} is no longer supported and contains multiple security vulnerabilities. Update to Android 13+ for optimal security.`,
          severity: androidVersion < 10 ? 'critical' : 'high',
          type: 'system',
          category: 'OS Security',
          riskScore: androidVersion < 10 ? 95 : 80,
          remediation: 'Update to the latest Android version available for your device',
          cve: null,
          affectedComponent: 'Android Operating System',
          exploitability: 'High',
          references: ['https://source.android.com/security/bulletin']
        });
      }

      // Security patch level check
      const patchLevel = await this.getSecurityPatchLevel();
      if (patchLevel) {
        const daysSincePatch = this.daysSince(new Date(patchLevel));
        
        if (daysSincePatch > 90) {
          this.addVulnerability({
            id: 'sys-patch-outdated',
            title: 'Outdated Security Patches',
            description: `Security patch level is ${daysSincePatch} days old. Devices should receive security updates monthly.`,
            severity: daysSincePatch > 180 ? 'high' : 'medium',
            type: 'system',
            category: 'Security Updates',
            riskScore: Math.min(90, daysSincePatch / 2),
            remediation: 'Check for and install available system updates',
            affectedComponent: 'System Security Patches',
            lastPatchDate: patchLevel
          });
        }
      }
    }

    // Boot loader security
    if (deviceInfo.isEmulator) {
      this.addVulnerability({
        id: 'sys-emulator',
        title: 'Running on Emulator',
        description: 'Device is running on an emulator which may have reduced security features',
        severity: 'low',
        type: 'device',
        category: 'Device Integrity',
        riskScore: 25,
        remediation: 'Use a physical device for production applications',
        affectedComponent: 'Device Environment'
      });
    }

    // Root/Jailbreak detection
    const isRooted = await this.detectRootAccess();
    if (isRooted) {
      this.addVulnerability({
        id: 'sys-rooted',
        title: 'Device is Rooted/Jailbroken',
        description: 'Device has been rooted/jailbroken, which bypasses built-in security mechanisms and increases attack surface.',
        severity: 'critical',
        type: 'device',
        category: 'Device Integrity',
        riskScore: 90,
        remediation: 'Un-root device and restore factory security settings',
        affectedComponent: 'System Security Model',
        exploitability: 'Critical'
      });
    }
  }

  // Scan for configuration-based vulnerabilities
  async scanConfigurationIssues() {
    const settings = await this.getDeviceSettings();
    
    // Developer options enabled
    if (settings.developerOptionsEnabled) {
      this.addVulnerability({
        id: 'config-dev-options',
        title: 'Developer Options Enabled',
        description: 'Developer options are enabled, which can expose debugging interfaces and reduce security.',
        severity: 'medium',
        type: 'configuration',
        category: 'Device Configuration',
        riskScore: 40,
        remediation: 'Disable Developer Options in Settings > System > Developer Options',
        affectedComponent: 'System Configuration'
      });
    }

    // USB Debugging enabled
    if (settings.usbDebuggingEnabled) {
      this.addVulnerability({
        id: 'config-usb-debug',
        title: 'USB Debugging Enabled',
        description: 'USB debugging allows external access to device internals and should be disabled in production.',
        severity: 'high',
        type: 'configuration',
        category: 'Debug Settings',
        riskScore: 65,
        remediation: 'Disable USB Debugging in Developer Options',
        affectedComponent: 'ADB Interface'
      });
    }

    // Screen lock configuration
    const screenLock = await this.checkScreenLockSecurity();
    if (screenLock.isWeak) {
      this.addVulnerability({
        id: 'config-weak-lock',
        title: 'Weak Screen Lock',
        description: screenLock.description,
        severity: 'medium',
        type: 'configuration',
        category: 'Access Control',
        riskScore: 50,
        remediation: 'Enable strong screen lock (PIN 6+ digits, password, or biometric)',
        affectedComponent: 'Screen Lock System'
      });
    }

    // App installation from unknown sources
    if (settings.unknownSourcesEnabled) {
      this.addVulnerability({
        id: 'config-unknown-sources',
        title: 'Installation from Unknown Sources Enabled',
        description: 'Device allows installation of apps from unknown sources, increasing malware risk.',
        severity: 'high',
        type: 'configuration',
        category: 'App Security',
        riskScore: 70,
        remediation: 'Disable installation from unknown sources in Security settings',
        affectedComponent: 'Package Manager'
      });
    }
  }

  // Scan for network-related vulnerabilities
  async scanNetworkVulnerabilities() {
    // Mock network vulnerability checks (in production, use actual network analysis)
    
    // Insecure WiFi networks
    const wifiNetworks = await this.scanWiFiNetworks();
    wifiNetworks.forEach(network => {
      if (network.security === 'open') {
        this.addVulnerability({
          id: `net-open-wifi-${network.ssid}`,
          title: 'Connected to Open WiFi Network',
          description: `Connected to unsecured WiFi "${network.ssid}". Open networks can intercept data transmission.`,
          severity: 'medium',
          type: 'network',
          category: 'Network Security',
          riskScore: 55,
          remediation: 'Avoid open WiFi networks or use VPN for secure connections',
          affectedComponent: 'WiFi Connection',
          networkSSID: network.ssid
        });
      }
      
      if (network.security === 'WEP') {
        this.addVulnerability({
          id: `net-wep-wifi-${network.ssid}`,
          title: 'Connected to WEP-Secured Network',
          description: `WiFi "${network.ssid}" uses outdated WEP encryption which can be easily broken.`,
          severity: 'high',
          type: 'network',
          category: 'Network Security',
          riskScore: 75,
          remediation: 'Switch to WPA3 or WPA2 secured networks',
          affectedComponent: 'WiFi Encryption',
          networkSSID: network.ssid
        });
      }
    });

    // DNS security
    const dnsConfig = await this.checkDNSConfiguration();
    if (dnsConfig.isInsecure) {
      this.addVulnerability({
        id: 'net-insecure-dns',
        title: 'Insecure DNS Configuration',
        description: 'Device is using potentially insecure DNS servers that may redirect or monitor traffic.',
        severity: 'medium',
        type: 'network',
        category: 'DNS Security',
        riskScore: 45,
        remediation: 'Use secure DNS services like Cloudflare (1.1.1.1) or Google (8.8.8.8)',
        affectedComponent: 'DNS Resolution'
      });
    }

    // Certificate pinning issues
    const certIssues = await this.checkCertificateIssues();
    if (certIssues.length > 0) {
      certIssues.forEach(issue => {
        this.addVulnerability({
          id: `net-cert-${issue.domain}`,
          title: 'Certificate Security Issue',
          description: issue.description,
          severity: issue.severity,
          type: 'network',
          category: 'Certificate Security',
          riskScore: issue.riskScore,
          remediation: issue.remediation,
          affectedComponent: 'SSL/TLS Certificates'
        });
      });
    }
  }

  // Scan for permission-based vulnerabilities
  async scanPermissionVulnerabilities() {
    // This would analyze system-wide permission configurations
    // For now, we'll create some example vulnerabilities
    
    const permissionAnalysis = await this.analyzeSystemPermissions();
    
    if (permissionAnalysis.excessiveLocationAccess > 5) {
      this.addVulnerability({
        id: 'perm-location-excessive',
        title: 'Excessive Location Permission Grants',
        description: `${permissionAnalysis.excessiveLocationAccess} apps have location access. Review which apps actually need location data.`,
        severity: 'medium',
        type: 'permission',
        category: 'Privacy Protection',
        riskScore: 40,
        remediation: 'Review and revoke location permissions for unnecessary apps',
        affectedComponent: 'Location Services',
        appCount: permissionAnalysis.excessiveLocationAccess
      });
    }

    if (permissionAnalysis.sensitiveDataAccess > 3) {
      this.addVulnerability({
        id: 'perm-sensitive-data',
        title: 'Multiple Apps Access Sensitive Data',
        description: `${permissionAnalysis.sensitiveDataAccess} apps have access to contacts, SMS, or call logs. Minimize sensitive data exposure.`,
        severity: 'medium',
        type: 'permission',
        category: 'Data Protection',
        riskScore: 50,
        remediation: 'Review and limit apps with access to sensitive personal data',
        affectedComponent: 'Data Access Controls',
        appCount: permissionAnalysis.sensitiveDataAccess
      });
    }
  }

  // Scan device security posture
  async scanDeviceSecurityPosture() {
    const securityFeatures = await this.checkSecurityFeatures();
    
    // Biometric security
    if (!securityFeatures.biometricsEnabled) {
      this.addVulnerability({
        id: 'posture-no-biometrics',
        title: 'Biometric Authentication Disabled',
        description: 'Biometric authentication (fingerprint/face unlock) is not enabled, reducing security convenience.',
        severity: 'low',
        type: 'configuration',
        category: 'Authentication',
        riskScore: 20,
        remediation: 'Enable fingerprint or face unlock in Security settings',
        affectedComponent: 'Biometric Authentication'
      });
    }

    // Encryption status
    if (!securityFeatures.deviceEncrypted) {
      this.addVulnerability({
        id: 'posture-no-encryption',
        title: 'Device Storage Not Encrypted',
        description: 'Device storage is not encrypted. If device is lost or stolen, data can be accessed directly.',
        severity: 'high',
        type: 'device',
        category: 'Data Protection',
        riskScore: 80,
        remediation: 'Enable device encryption in Security settings',
        affectedComponent: 'Storage Encryption'
      });
    }

    // Auto-lock timing
    if (securityFeatures.autoLockDelay > 300) { // 5 minutes
      this.addVulnerability({
        id: 'posture-long-autolock',
        title: 'Auto-lock Delay Too Long',
        description: `Device auto-locks after ${securityFeatures.autoLockDelay} seconds. Shorter delays improve security.`,
        severity: 'low',
        type: 'configuration',
        category: 'Access Control',
        riskScore: 15,
        remediation: 'Set auto-lock to 30 seconds or less',
        affectedComponent: 'Screen Lock Timer'
      });
    }

    // Find My Device / Remote Wipe
    if (!securityFeatures.findMyDeviceEnabled) {
      this.addVulnerability({
        id: 'posture-no-remote-wipe',
        title: 'Remote Device Management Disabled',
        description: 'Find My Device or similar remote management is disabled. Cannot remotely wipe if device is lost.',
        severity: 'medium',
        type: 'configuration',
        category: 'Device Management',
        riskScore: 35,
        remediation: 'Enable Find My Device or Google Device Manager',
        affectedComponent: 'Remote Device Management'
      });
    }
  }

  // Scan for known CVEs affecting the device
  async scanKnownCVEs() {
    const deviceInfo = await this.getDeviceInfo();
    
    if (Platform.OS === 'android') {
      const majorVersion = deviceInfo.osVersion.split('.')[0];
      const knownCVEs = this.knownCVEs.android[majorVersion] || [];
      
      knownCVEs.forEach(cve => {
        this.addVulnerability({
          id: `cve-${cve.cve}`,
          title: cve.title,
          description: `${cve.description}\n\nCVSS Score: ${cve.cvss}/10`,
          severity: cve.severity,
          type: 'cve',
          category: 'Known Vulnerabilities',
          riskScore: Math.round(cve.cvss * 10),
          remediation: 'Update to a newer Android version that patches this vulnerability',
          cve: cve.cve,
          cvss: cve.cvss,
          affectedComponent: 'Android System',
          exploitability: cve.cvss >= 9 ? 'Critical' : cve.cvss >= 7 ? 'High' : 'Medium'
        });
      });
    }
  }

  // Helper methods
  addVulnerability(vuln) {
    const vulnerability = {
      ...vuln,
      id: vuln.id || `vuln-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      timestamp: new Date().toISOString(),
      status: 'active',
      source: 'pocketshield_scanner'
    };
    
    this.vulnerabilities.push(vulnerability);
  }

  async getDeviceInfo() {
    return {
      brand: Device.brand || 'Unknown',
      manufacturer: Device.manufacturer || 'Unknown',
      modelName: Device.modelName || 'Unknown',
      osVersion: Device.osVersion || 'Unknown',
      platform: Platform.OS,
      isDevice: Device.isDevice,
      isEmulator: !Device.isDevice
    };
  }

  async getSecurityPatchLevel() {
    // In production, this would get actual security patch level
    // For now, simulate based on Android version
    if (Platform.OS === 'android') {
      const now = new Date();
      const randomDaysAgo = Math.floor(Math.random() * 120) + 30; // 30-150 days ago
      const patchDate = new Date(now.getTime() - (randomDaysAgo * 24 * 60 * 60 * 1000));
      return patchDate.toISOString().split('T')[0];
    }
    return null;
  }

  async detectRootAccess() {
    // Mock root detection - in production use proper root detection library
    return Math.random() < 0.1; // 10% chance for demo
  }

  async getDeviceSettings() {
    // Mock device settings - in production, access actual device settings
    return {
      developerOptionsEnabled: Math.random() < 0.3,
      usbDebuggingEnabled: Math.random() < 0.15,
      unknownSourcesEnabled: Math.random() < 0.2
    };
  }

  async checkScreenLockSecurity() {
    // Mock screen lock check
    const lockTypes = [
      { type: 'none', isWeak: true, description: 'No screen lock configured' },
      { type: 'swipe', isWeak: true, description: 'Swipe unlock provides no security' },
      { type: 'pattern', isWeak: true, description: 'Pattern unlock can be easily observed and replicated' },
      { type: 'pin_short', isWeak: true, description: 'PIN with less than 6 digits is easily guessable' },
      { type: 'pin_strong', isWeak: false, description: 'Strong PIN with 6+ digits' },
      { type: 'password', isWeak: false, description: 'Strong password protection' },
      { type: 'biometric', isWeak: false, description: 'Biometric authentication enabled' }
    ];
    
    return lockTypes[Math.floor(Math.random() * lockTypes.length)];
  }

  async scanWiFiNetworks() {
    // Mock WiFi scan - in production use actual network scanning
    const mockNetworks = [
      { ssid: 'FreeWiFi', security: 'open' },
      { ssid: 'CafeWiFi', security: 'WEP' },
      { ssid: 'HomeNetwork', security: 'WPA2' },
      { ssid: 'OfficeNetwork', security: 'WPA3' }
    ];
    
    // Return random network (simulating current connection)
    return [mockNetworks[Math.floor(Math.random() * mockNetworks.length)]];
  }

  async checkDNSConfiguration() {
    // Mock DNS check
    return {
      isInsecure: Math.random() < 0.4, // 40% chance of insecure DNS
      dnsServers: ['8.8.8.8', '8.8.4.4'] // Mock DNS servers
    };
  }

  async checkCertificateIssues() {
    // Mock certificate issues
    const issues = [];
    if (Math.random() < 0.2) { // 20% chance of cert issues
      issues.push({
        domain: 'example-site.com',
        description: 'Weak SSL certificate detected on frequently accessed site',
        severity: 'medium',
        riskScore: 45,
        remediation: 'Avoid entering sensitive information on this site'
      });
    }
    return issues;
  }

  async analyzeSystemPermissions() {
    // Mock permission analysis
    return {
      excessiveLocationAccess: Math.floor(Math.random() * 10),
      sensitiveDataAccess: Math.floor(Math.random() * 8),
      totalAppsWithPermissions: Math.floor(Math.random() * 50) + 20
    };
  }

  async checkSecurityFeatures() {
    // Mock security features check
    return {
      biometricsEnabled: Math.random() < 0.7,
      deviceEncrypted: Math.random() < 0.8,
      autoLockDelay: Math.floor(Math.random() * 600) + 30, // 30-630 seconds
      findMyDeviceEnabled: Math.random() < 0.6
    };
  }

  daysSince(date) {
    const now = new Date();
    const diffTime = Math.abs(now - date);
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  }

  async cacheResults() {
    try {
      const cacheData = {
        vulnerabilities: this.vulnerabilities,
        lastScanTime: this.lastScanTime.toISOString(),
        scanVersion: '1.0'
      };
      await AsyncStorage.setItem('vulnerability_scan_results', JSON.stringify(cacheData));
    } catch (error) {
      console.error('Failed to cache vulnerability results:', error);
    }
  }

  async loadCachedResults() {
    try {
      const cachedData = await AsyncStorage.getItem('vulnerability_scan_results');
      if (cachedData) {
        const parsed = JSON.parse(cachedData);
        this.vulnerabilities = parsed.vulnerabilities || [];
        this.lastScanTime = parsed.lastScanTime ? new Date(parsed.lastScanTime) : null;
        return true;
      }
    } catch (error) {
      console.error('Failed to load cached vulnerability results:', error);
    }
    return false;
  }

  // Get vulnerability summary stats
  getVulnerabilitySummary() {
    const critical = this.vulnerabilities.filter(v => v.severity === 'critical').length;
    const high = this.vulnerabilities.filter(v => v.severity === 'high').length;
    const medium = this.vulnerabilities.filter(v => v.severity === 'medium').length;
    const low = this.vulnerabilities.filter(v => v.severity === 'low').length;

    return {
      total: this.vulnerabilities.length,
      critical,
      high,
      medium,
      low,
      lastScanTime: this.lastScanTime,
      categories: this.getCategoryCounts()
    };
  }

  getCategoryCounts() {
    const categories = {};
    this.vulnerabilities.forEach(vuln => {
      categories[vuln.category] = (categories[vuln.category] || 0) + 1;
    });
    return categories;
  }

  // Get vulnerabilities by filter
  getVulnerabilities(filter = 'all') {
    if (filter === 'all') return this.vulnerabilities;
    return this.vulnerabilities.filter(v => v.severity === filter);
  }
}

export default new VulnerabilityDetectionService();
